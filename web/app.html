<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Postura • Analyzer</title>
    <style>
      :root { --muted:#9CA3AF; --accent:#A855F7; --accent-2:#C1A6FF; --light:#E5E7EB; --bg:#0B0F14; --card:#0F141B; --border:rgba(156,163,175,.18); --success:#22c55e; --danger:#ef4444; --shadow:0 10px 30px rgba(168,85,247,.15),0 6px 16px rgba(193,166,255,.08);} 
      *{ box-sizing:border-box } html,body{ height:100% } body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--light); background:var(--bg) }
      .container{ max-width:1200px; margin:0 auto; padding:28px 24px } header{ display:flex; align-items:center; gap:12px; margin-bottom:18px }
      .logo{ width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:var(--shadow) }
      h1{ font-size:22px; margin:0; letter-spacing:.2px } .subtitle{ color:var(--muted); font-size:13px }
      .grid{ display:grid; grid-template-columns:1.15fr .85fr; gap:18px }
      .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:var(--shadow) }
      .btn{ appearance:none; border:0; border-radius:10px; padding:10px 16px; font-weight:600; color:#0b0f14; background:linear-gradient(135deg,var(--accent),var(--accent-2)); cursor:pointer; box-shadow:var(--shadow); position:relative; overflow:hidden }
      .hint{ color:var(--muted); font-size:12px }
      .status-row{ display:flex; align-items:center; gap:10px; margin:8px 0 12px; flex-wrap:wrap } .pill{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--light) }
      .pill.uploading{ background:rgba(229,231,235,.08); border-color:var(--light) } .pill.fetching{ background:rgba(168,85,247,.12); border-color:var(--accent-2) } .pill.processing{ border-color:var(--accent-2); background:rgba(193,166,255,.12) } .pill.done{ border-color:var(--success); color:#10b981; background:rgba(16,185,129,.12) } .pill.error{ border-color:var(--danger); color:#ef4444; background:rgba(239,68,68,.12) }
      .progress-wrap{ width:100%; height:12px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; border:1px solid var(--border) } .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width .15s linear }
      .eta{ font-size:12px; color:var(--muted); margin-left:6px } .times{ font-size:12px; color:var(--muted); display:flex; gap:12px; flex-wrap:wrap }
      details{ border:1px dashed var(--border); border-radius:8px; padding:8px; margin-top:8px } details > summary { list-style:none; cursor:pointer; padding:6px 10px; border-radius:999px; display:inline-block; margin-bottom:6px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0B0F14; font-weight:700; } details > summary::-webkit-details-marker{ display:none }
      textarea{ width:100%; min-height:120px; resize:vertical; background:rgba(0,0,0,.35); color:var(--light); border:1px solid var(--border); border-radius:8px; padding:8px }
      .stats{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:8px } .stat{ background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center } .stat .num{ font-size:26px; font-weight:800 }
      .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px } .chip{ padding:4px 8px; border-radius:999px; background:rgba(168,85,247,.18); border:1px solid var(--border); font-size:12px }
      .thumbs{ display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:10px }
      .thumb{ border:1px solid var(--border); border-radius:10px; overflow:hidden; background:rgba(255,255,255,.02) } .thumb img{ width:100%; display:block } .thumb figcaption{ padding:6px 8px; font-size:12px; color:var(--muted) }
      .sparkline{ width:100%; height:60px; margin-top:8px }
      @media (max-width: 900px){
        .grid{ grid-template-columns: 1fr; }
        .container{ padding:22px 16px }
        header{ flex-wrap:wrap }
        h1{ font-size:20px }
        .subtitle{ font-size:12px }
        .stats{ grid-template-columns: repeat(2,1fr) }
      }
      @media (max-width: 560px){
        .stats{ grid-template-columns: 1fr }
        .links{ flex-direction:column }
        .btn{ width:100% }
        .dropzone{ padding:22px 16px }
      }
      .dropzone{ position:relative; border:2px solid transparent; border-radius:12px; padding:30px 24px; text-align:center; cursor:pointer; transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease; background: linear-gradient(var(--card), var(--card)) padding-box, linear-gradient(135deg, var(--accent), var(--accent-2), var(--light), var(--accent)) border-box; background-origin: border-box; background-clip: padding-box, border-box; background-size: 100% 100%, 300% 300%; background-position: 0 0, 0% 50%; animation: edgeAnim 12s linear infinite; }
      @keyframes edgeAnim { 0%{ background-position: 0 0, 0% 50%; } 100%{ background-position: 0 0, 300% 50%; } }
      .dropzone:hover{ transform: translateY(-1px); box-shadow: 0 6px 16px rgba(168,85,247,.15); animation-play-state: paused; }
      .dropzone.dragover{ transform: translateY(-2px) scale(1.01); box-shadow: 0 10px 24px rgba(168,85,247,.22); }
      .links { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
      .link-green { display:inline-block; padding:6px 10px; border-radius:999px; background:linear-gradient(135deg,#16a34a,#22c55e); color:#0B0F14; font-weight:700; text-decoration:none }
      /* Modal */
      .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000 }
      .modal{ width:min(520px,90vw); background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.45) }
      .modal h3{ margin:0 0 8px 0 }
      .modal p{ margin:0 0 12px 0; color:var(--muted) }
      .modal .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo"></div>
        <div>
          <h1>Postura • Analyzer</h1>
          <div class="subtitle">Upload MP4 (≤ 50MB). Your summary is saved under <code>/reports/{video_id}/summary.json</code>.</div>
        </div>
      </header>
      <div class="grid">
        <div class="card">
          <h3>Upload</h3>
          <div id="drop" class="dropzone">
            <strong>Drag & drop</strong> video here, or click to choose
            <div class="hint">Accepted: video/mp4</div>
            <input id="file" type="file" accept="video/mp4" hidden />
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:10px">
            <button id="btn" class="btn">Analyze</button>
            <button id="retry" class="btn" style="display:none">Re‑run</button>
            <button id="cancel" class="btn" style="display:none; background:linear-gradient(135deg,#ef4444,#f59e0b)">Cancel</button>
            <span id="fileName" class="hint">No file selected</span>
          </div>
          
        </div>
        <div class="card">
          <h3>Status</h3>
          <div class="status-row"><span id="statusPill" class="pill">Idle</span><span id="eta" class="eta"></span></div>
          <div class="progress-wrap"><div id="bar" class="progress-bar"></div></div>
          <div id="times" class="times">Uploading: 0s • Fetching: 0s • Processing: 0s</div>
          <div id="reportLink" class="links" style="margin-top:6px"></div>
          <details open style="margin-top:8px"><summary>Live logs</summary><textarea id="logs" readonly></textarea></details>
        </div>
      </div>
      <div class="grid" style="margin-top:14px">
        <div class="card">
          <h3>Demo Library</h3>
          <div class="hint">Drag the badge into the dropzone above, or click “Load into uploader”.</div>
          <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:12px; margin-top:10px">
            <div>
              <video src="/demo/pushup.mp4" controls style="width:100%; border-radius:8px; border:1px solid var(--border)"></video>
              <div style="display:flex; gap:8px; align-items:center; margin-top:6px">
                <span class="pill" draggable="true" id="dragPush">Drag: Pushups</span>
                <button class="btn" id="loadPush">Load into uploader</button>
              </div>
            </div>
            <div>
              <video src="/demo/squats.mp4" controls style="width:100%; border-radius:8px; border:1px solid var(--border)"></video>
              <div style="display:flex; gap:8px; align-items:center; margin-top:6px">
                <span class="pill" draggable="true" id="dragSquat">Drag: Squats</span>
                <button class="btn" id="loadSquat">Load into uploader</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid" style="margin-top:14px">
        <div class="card">
          <h3>Summary</h3>
          <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:8px">
            <div class="stat"><div>Squats</div><div id="squatsNum" class="num">0</div></div>
            <div class="stat"><div>Pushups</div><div id="pushupsNum" class="num">0</div></div>
            <div class="stat"><div>Good‑form</div><div id="goodNum" class="num">0</div></div>
          </div>
          <div id="chips" class="chips"></div>
          <svg id="spark" class="sparkline" viewBox="0 0 600 60"></svg>
          <details open style="margin-top:8px"><summary>Raw JSON</summary><pre id="out">{ "state": "waiting" }</pre></details>
        </div>
        <div class="card">
          <h3>Annotated Snapshots</h3>
          <div id="thumbs" class="thumbs"><div class="thumb"><figcaption style="padding:6px 8px">Awaiting thumbnails…</figcaption></div></div>
        </div>
      </div>
    </div>
    <div id="doneModal" class="modal-backdrop">
      <div class="modal">
        <h3>Analysis complete</h3>
        <p>Your report is ready. You can view downloads or open a dedicated results page.</p>
        <div class="actions">
          <a id="mSum" class="link-green" href="#" target="_blank">Open summary.json</a>
          <a id="mPdf" class="link-green" href="#" target="_blank">Open PDF report</a>
          <a id="mPage" class="btn" href="#">Open results page</a>
          <button id="mClose" class="btn" style="background:linear-gradient(135deg,#6b7280,#9ca3af)">Close</button>
        </div>
      </div>
    </div>
    <script>
      const file=document.getElementById('file'); const drop=document.getElementById('drop'); const btn=document.getElementById('btn'); const retry=document.getElementById('retry'); const cancel=document.getElementById('cancel'); const nameEl=document.getElementById('fileName'); const bar=document.getElementById('bar'); const pill=document.getElementById('statusPill'); const eta=document.getElementById('eta'); const times=document.getElementById('times'); const out=document.getElementById('out'); const logs=document.getElementById('logs'); const link=document.getElementById('reportLink'); const squatsNum=document.getElementById('squatsNum'); const pushupsNum=document.getElementById('pushupsNum'); const goodNum=document.getElementById('goodNum'); const chips=document.getElementById('chips'); const spark=document.getElementById('spark'); const thumbs=document.getElementById('thumbs');
      const qs = new URLSearchParams(location.search);
      const savedBase = (typeof localStorage!=='undefined'? localStorage.getItem('API_BASE') : '') || '';
      const DEFAULT_BASE = 'https://postura-779u.onrender.com';
      const API_BASE = (qs.get('api') || savedBase || DEFAULT_BASE || '').replace(/\/$/, '');
      function apiUrl(p){ return (API_BASE? (API_BASE + p) : p); }
      let visual=0, target=0, startTs=0, upTs=0, fetchTs=0, procTs=0, currentId=null, polling=false, lastFiles=null;
      (function anim(){ if(visual<target){ const d=Math.max(0.003,(target-visual)*0.12); visual=Math.min(target,visual+d); bar.style.width=`${Math.round(visual*100)}%`; } requestAnimationFrame(anim);})();
      function setPill(s){ pill.className='pill'; pill.textContent=s.charAt(0).toUpperCase()+s.slice(1); pill.classList.add(s); }
      function fmtTimes(){ times.textContent = `Uploading: ${Math.round(upTs)}s • Fetching: ${Math.round(fetchTs)}s • Processing: ${Math.round(procTs)}s`; }
      drop.addEventListener('click', ()=>file.click()); drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.classList.add('dragover');}); drop.addEventListener('dragleave',()=>{ drop.classList.remove('dragover');}); drop.addEventListener('drop', async e=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files&&e.dataTransfer.files[0]){ file.files=e.dataTransfer.files; onChange(); return;} const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain'); if(url){ try{ const r=await fetch(url); const b=await r.blob(); const f = new File([b], url.split('/').pop()||'demo.mp4', { type:'video/mp4' }); const dt = new DataTransfer(); dt.items.add(f); file.files = dt.files; onChange(); }catch{} } }); file.addEventListener('change', onChange);
      function onChange(){ if(file.files.length){ const f=file.files[0]; nameEl.textContent=`${f.name} · ${(f.size/1024/1024).toFixed(2)} MB`; lastFiles=file.files; } }
      btn.addEventListener('click', start); retry.addEventListener('click', ()=>{ if(lastFiles){ file.files=lastFiles; start(); }}); cancel.addEventListener('click', ()=>{ polling=false; setPill('error'); });
      function reset(){ visual=0; target=0; startTs=0; upTs=0; fetchTs=0; procTs=0; out.textContent='{ "state": "waiting" }'; logs.value=''; link.textContent=''; chips.innerHTML=''; spark.innerHTML=''; thumbs.innerHTML='<div class="thumb"><figcaption style="padding:6px 8px">Awaiting thumbnails…</figcaption></div>'; eta.textContent=''; retry.style.display='none'; cancel.style.display='inline-block'; }
      async function start(){ if(!file.files.length){ alert('Select a file'); return; } reset(); const f=file.files[0]; await startWithFile(f); }
      async function startWithFile(f){ const form=new FormData(); form.append('file', f, f.name||'input.mp4'); const xhr=new XMLHttpRequest(); xhr.open('POST', apiUrl('/analyze'), true); xhr.responseType='json'; startTs=performance.now()/1000; setPill('uploading'); xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ target=Math.max(0.05, Math.min(0.7, e.loaded/e.total*0.7)); upTs=(performance.now()/1000)-startTs; fmtTimes(); }}; xhr.onload=()=>{ upTs=Math.max(upTs, (performance.now()/1000)-startTs); fmtTimes(); if(xhr.status!==202){ setPill('error'); out.textContent=JSON.stringify(xhr.response||{},null,2); return; } const resp=xhr.response; currentId=resp.video_id; window.currentJobId = currentId; setPill('fetching'); target=Math.max(target, 0.75); polling=true; poll(); streamLogs(); }; xhr.onerror=()=>{ setPill('error'); }; xhr.send(form); }
      async function poll(){ if(!currentId||!polling) return; try{ const r=await fetch(apiUrl(`/status/${currentId}`)); const s=await r.json(); out.textContent=JSON.stringify(s,null,2); if(s.status==='processing'){ setPill('processing'); if(typeof s.progress==='number'){ target=Math.max(target, Math.min(0.95, 0.75 + 0.2*s.progress)); procTs = (performance.now()/1000) - startTs - upTs - fetchTs; fmtTimes(); if(s.eta_seconds){ eta.textContent = `ETA ${Math.round(s.eta_seconds)}s`; } } } if(s.status==='done'){ target=1.0; setPill('done'); eta.textContent=''; polling=false; cancel.style.display='none'; retry.style.display='inline-block'; const res=await (await fetch(apiUrl(`/result/${currentId}`))).json(); renderSummary(res); renderThumbs(res); showDoneModal(currentId); return; } if(s.status==='error'){ polling=false; setPill('error'); cancel.style.display='none'; retry.style.display='inline-block'; return; } fetchTs = (performance.now()/1000) - startTs - upTs - procTs; fmtTimes(); setTimeout(poll, 900);}catch(e){ setTimeout(poll, 1200);} }
      function showDoneModal(id){ const bd=document.getElementById('doneModal'); const mSum=document.getElementById('mSum'); const mPdf=document.getElementById('mPdf'); const mPage=document.getElementById('mPage'); const mClose=document.getElementById('mClose'); mSum.href= apiUrl(`/reports/${id}/summary.json`); mPdf.href= apiUrl(`/report/${id}.pdf`); const apiArg = API_BASE? `&api=${encodeURIComponent(API_BASE)}`:''; mPage.href=`/ui/result.html?video_id=${encodeURIComponent(id)}${apiArg}`; bd.style.display='flex'; mClose.onclick=()=>{ bd.style.display='none'; }; }
      async function streamLogs(){ if(!currentId) return; try{ const txt = await (await fetch(apiUrl(`/logs/${currentId}`))).text(); logs.value = txt; logs.scrollTop = logs.scrollHeight; }catch{} if(polling) setTimeout(streamLogs, 1000); }
      function renderSummary(res){ const s=res.summary||{}; const sq=s.squats||{total_reps:0,good_form_reps:0,common_issues:[]}; const pu=s.pushups||{total_reps:0,good_form_reps:0,common_issues:[]}; squatsNum.textContent=String(sq.total_reps||0); pushupsNum.textContent=String(pu.total_reps||0); goodNum.textContent=String((sq.good_form_reps||0)+(pu.good_form_reps||0)); const allIssues=[...(sq.common_issues||[]), ...(pu.common_issues||[])]; chips.innerHTML = allIssues.map(x=>`<span class="chip">${x}</span>`).join(''); drawSpark(res); if(window.currentJobId){ link.innerHTML = `<a class="link-green" href="${apiUrl('/reports/'+window.currentJobId+'/summary.json')}" target="_blank">Open saved summary.json</a><a class="link-green" href="${apiUrl('/report/'+window.currentJobId+'.pdf')}" target="_blank">Report PDF</a>`; } }
      function drawSpark(res){ const data=(res.frame_data||[]).map(r=>({x:r.frame_index, y:(r.angles && (r.angles.knee||r.angles.elbow))||0})); if(!data.length){ spark.innerHTML=''; return; } const w=600,h=60; const xs=data.map(d=>d.x), ys=data.map(d=>d.y); const minX=Math.min(...xs), maxX=Math.max(...xs); const minY=Math.min(...ys), maxY=Math.max(...ys); const sx=(x)=> (maxX===minX?0:((x-minX)/(maxX-minX))*w); const sy=(y)=> h - (maxY===minY? h/2:((y-minY)/(maxY-minY))*h); const pts=data.map(p=>`${sx(p.x)},${sy(p.y)}`).join(' '); const marks=data.map(p=>`<circle cx="${sx(p.x)}" cy="${sy(p.y)}" r="2.5" fill="#A855F7" />`).join(''); spark.innerHTML = `<polyline fill="none" stroke="#C1A6FF" stroke-width="2" points="${pts}" />${marks}`; }
      function renderThumbs(res){ const t=res.thumbnails||[]; if(!t.length){ thumbs.innerHTML = '<div class="thumb"><figcaption style="padding:6px 8px">No snapshots available</figcaption></div>'; return; } thumbs.innerHTML = t.map(it=>`<figure class="thumb"><img src="${API_BASE? (API_BASE+it.path) : it.path}" alt="rep ${it.rep_id}"/><figcaption>Rep ${it.rep_id} • ${it.exercise} • ${((it.angles&& (it.angles.knee||it.angles.elbow))||0).toFixed(1)}°</figcaption></figure>`).join(''); }
      
      
      function setupDrag(id, url){ const el=document.getElementById(id); if(!el) return; el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/uri-list', url); ev.dataTransfer.effectAllowed='copy'; }); }
      setupDrag('dragPush','/demo/pushup.mp4'); setupDrag('dragSquat','/demo/squats.mp4');
      async function loadIntoUploader(url){ try{ const r=await fetch(url); const b=await r.blob(); const f=new File([b], url.split('/').pop()||'demo.mp4', {type:'video/mp4'}); const dt=new DataTransfer(); dt.items.add(f); file.files=dt.files; onChange(); }catch{ alert('Failed to fetch demo'); } }
      document.getElementById('loadPush').addEventListener('click', ()=> loadIntoUploader('/demo/pushup.mp4'));
      document.getElementById('loadSquat').addEventListener('click', ()=> loadIntoUploader('/demo/squats.mp4'));
    </script>
  </body>
</html>
